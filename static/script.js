import {CodeJar} from './codejar/codejar.js'
const editor = document.querySelector('#editor')
globalThis.editor_content = get_test_content(); //'function foo() {\n\treturn "Hi"\n}'

const highlight = editor => {
    editor.innerHTML = hljs.highlight(editor.textContent, { language: 'markdown' }).value
}

const jar = CodeJar(editor, highlight, {
    tab: '    ',
})

jar.updateCode(globalThis.editor_content)
jar.onUpdate(code => { globalThis.editor_content = code })
//jar.updateCode(localStorage.getItem('code'))
//jar.onUpdate(code => { localStorage.setItem('code', code) })

/*================================================================================*/

import * as db from './db.js'
import * as parser from './parser.js'

console.log(await db.get_all_image_names())
// console.dir(JSON.stringify(parser.parseReport(get_test_content()), null, 4))

function get_test_content() {
    // {{{
    return `
#@ РЕФЕРАТ

Отчёт 15 страниц, 5 рисунков, 15 источников

ИНТЕРНЕТ, РАЗРАБОТКА, ВЕБ‑ТЕХНОЛОГИИ, ASCIIDOC, GLEAM, ACE, SVG, PDF

Объект исследования – веб‑приложение для редактирования и конвертации документов формата Asciidoc.

Предмет исследования – процесс разработки, создания и функционирования веб‑приложения для работы с Asciidoc.

Цель работы – разработка архитектуры и прототипа веб‑приложения, позволяющего редактировать документы в формате Asciidoc и конвертировать их в SVG и PDF с соблюдением ГОСТ.

В ходе работы был проведён анализ существующих форматов разметки и инструментов для работы с ними. Рассмотрен процесс создания веб‑приложения, включая выбор архитектуры, используемого программного обеспечения и инструментов разработки.

Результатом работы является прототип веб‑приложения, который обеспечивает удобное редактирование и просмотр документов в реальном времени, а также экспорт в форматы SVG и PDF. Приложение демонстрирует высокую производительность и удобство использования, что позволяет ему конкурировать с существующими инструментами для работы с документами в сети интернет.

#% Содержание

#@ ВВЕДЕНИЕ

В данной курсовой работе рассматривается разработка и анализ архитектуры веб‑приложения для редактирования и конвертации документов в формате Asciidoc. Целью данного приложения является упрощение работы с технической документацией и отчётами, автоматизируя процесс преобразования документов в форматы SVG и PDF с соблюдением стандартов ГОСТ.

Актуальность выбранной темы обусловлена растущей популярностью форматов разметки для создания структурированных текстов и недостатком удобных инструментов для работы с Asciidoc, особенно в контексте применения национальных стандартов. Существующие решения либо слишком сложны в использовании, либо не предоставляют необходимых функций для быстрой и качественной конвертации.

Целью данной курсовой работы является разработка архитектуры и прототипа веб‑приложения, предоставляющего удобный интерфейс для работы с Asciidoc и позволяющего экспортировать документы в популярные форматы с сохранением всех структурных элементов.

Для достижения цели были поставлены следующие задачи:

- изучить формат Asciidoc и его применение в современных рабочих процессах;
- провести анализ существующих инструментов для работы с Asciidoc и определить их преимущества и недостатки;
- разработать архитектуру приложения, включающую клиентскую и серверную части;
- спроектировать потоки данных для обработки документов и экспорта их в SVG и PDF;
- выбрать и обосновать используемые технологии, такие как Gleam для серверной части, Ace Editor для клиентского редактора, а также инструменты для конвертации форматов;
- реализовать минимальный жизнеспособный прототип приложения с базовым функционалом, включая редактирование текста, предварительный просмотр и экспорт;
- провести тестирование производительности, удобства использования и соответствия заявленным требованиям.

# Описание предметной области

## Анализ формата Asciidoc

Формат Asciidoc[1] представляет собой мощный текстовый формат разметки, который применяется для создания технической документации, статей, презентаций и других типов текстовых документов. Его основным преимуществом является поддержка сложных структур, таких как таблицы, списки, врезки и изображения, что делает его более функциональным по сравнению с Markdown[2].

Преимущества Asciidoc:

- гибкость и возможность расширения;
- поддержка различных форматов экспорта (HTML, PDF, DocBook и др.);
- простой и читабельный синтаксис.

## Обоснование выбора Asciidoc

На основании анализа существующих решений было принято решение использовать Asciidoc в качестве основного формата для приложения. Среди альтернатив рассматривались LaTeX[3] и Markdown, однако:

- LaTeX сложен в освоении и требует установки специфического программного обеспечения;
- Markdown обладает более ограниченным функционалом, чем Asciidoc.

## Функциональные требования к системе

Для реализации веб‑приложения необходимо обеспечить следующие возможности:

- редактирование текста в формате Asciidoc через встроенный редактор Ace Editor;
- просмотр результатов в реальном времени в формате SVG;
- экспорт документа в форматы SVG[5] и PDF с соблюдением стандартов ГОСТ;
- минимизация запросов к серверу (клиент обрабатывает предварительный просмотр, сервер — экспорт).

## Нефункциональные требования к системе

- время обработки текста (SVG/PDF) не должно превышать 3 секунд для документов объёмом 10–20 страниц;
- интуитивно понятный минималистичный интерфейс для десктопа и мобильных устройств;
- кроссплатформенность (Chrome, Firefox, Safari, Edge);
- масштабируемость кода для добавления новых функций;
- безопасность: HTTPS и отсутствие хранения личных данных пользователей.

## Ограничения системы

- серверная часть написана на Gleam, что ограничивает выбор библиотек;
- поддерживается только Asciidoc как формат входных данных;
- отсутствует система хранения и истории документов;
- возможны задержки при обработке документов более 100 страниц;
- нет поддержки совместного редактирования.

# Проектирование архитектуры

## Выбранная архитектура

Архитектура приложения — клиент‑серверная модель SPA. Клиент (Ace Editor + JS) конвертирует Asciidoc в SVG для предпросмотра, сервер (Gleam) — в PDF.

image::blob:http://localhost:42069/d4deb6f7-124f-4efe-ba74-9968870ab851[Клиент‑серверная архитектура]

### Составляющие архитектуры

- **Клиентская часть**: Ace Editor для подсветки и редактирования Asciidoc;
- **Серверная часть**: Gleam — обработка данных и конвертация SVG→PDF;
- **Хранилище данных**: пока отсутствует (MVP), в будущем SQLite[7].

## Будущие улучшения

Переход на The Elm Architecture для более чёткого управления состоянием:

image::blob:http://localhost:42069/73c43758-506c-45c8-b4f4-020941e66ae9[Архитектура TEA]

# Реализация MVP

## Основные функции

- редактирование Asciidoc;
- предпросмотр SVG;
- экспорт SVG/PDF.

Используемые технологии:

- Ace Editor;
- JS‑конвертация Asciidoc→SVG;
- Gleam для сервера;
- GNU awk для разбивки страниц SVG;
- svg2pdf для одной страницы SVG;
- GhostScript для объединения в PDF.

# Инфраструктура

Используется домашний сервер на Void Linux[13] и Ngrok[14] для публичного доступа.

- **Void Linux**: минимализм и контроль над ресурсами;
- **Ngrok**: проброс локального порта в интернет;
- **Браузер**: клиентское приложение.

# Иллюстрация последовательности действий

image::blob:http://localhost:42069/c1c8949f-e689-466d-b14f-e51f0075809b[Диаграмма последовательности]

# Потоки данных (DFD)

## Описание потоков данных

- Asciidoc→SVG→клиент;
- Asciidoc→SVG→PDF→клиент.

## Иллюстрация потоков данных

image::blob:http://localhost:42069/2c07074f-9287-467e-b063-b963073120c5[Диаграмма потока данных]

# Тестирование

## Тестирование UX/UI

image::blob:http://localhost:42069/560c829b-02c6-4046-85cc-7314a643396f[Скриншот работы сайта]

## Проверка функциональности

- конвертация Asciidoc→SVG;
- конвертация SVG→PDF;
- соответствие ГОСТ.

## Результаты тестирования

- время обработки запросов;
- корректность отображения;
- отсутствие ошибок при экспорте.

#@ Заключение

Приложение обеспечивает удобное редактирование Asciidoc, масштабируемую архитектуру и экспорт по ГОСТ. Код хранится в локальном репозитории и на GitHub[15].

В планах:

- внедрение аккаунтов пользователей;
- поддержка дополнительных форматов;
- оптимизация производительности.

# Code block

\`\`\`gleam
pub fn convert(doc: String) -> Result(Svg, String) {
  let svg = asciidoc_to_svg(doc)
  case svg {
    Ok(data) -> save_to_file(data, "output.svg")
    Error(reason) -> Error("Conversion failed: " <> reason)
  }
}
\`\`\`

# A Table

[cols="1,2,2", options="header", bool-opt-1, bool-opt-2, key="value"]
|===
| ID | Название | Описание
| 001 | Lorem Ipsum | Lorem ipsum dolor sit amet, consectetur adipiscing elit.
| 002 | Dolor Sit | Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
| 003 | Amet Consectetur | Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
| 004 | Adipiscing Elit | Duis aute irure dolor in reprehenderit in voluptate velit esse.
|===

#@ СПИСОК ИСТОЧНИКОВ И ЛИТЕРАТУРЫ

. Asciidoc [Электронный ресурс]. – URL: https://asciidoc.org/ (дата обращения 09.12.2024).
. MarkDown [Электронный ресурс]. – URL: https://www.markdownguide.org/ (дата обращения 09.12.2024).
. LaTeX [Электронный ресурс]. – URL: https://www.latex-project.org/ (дата обращения 09.12.2024).
. Ace Editor [Электронный ресурс]. – URL: https://ace.c9.io/ (дата обращения 09.12.2024).
. SVG [Электронный ресурс]. – URL: https://www.w3.org/Graphics/SVG/ (дата обращения 09.12.2024).
. Gleam [Электронный ресурс]. – URL: https://gleam.run/ (дата обращения 09.12.2024).
. SQLite [Электронный ресурс]. – URL: https://www.sqlite.org/index.html (дата обращения 09.12.2024).
. Elm [Электронный ресурс]. – URL: https://elm-lang.org/ (дата обращения 09.12.2024).
. GNU awk [Электронный ресурс]. – URL: https://www.gnu.org/software/gawk/manual/gawk.html (дата обращения 09.12.2024).
. svg2pdf [Электронный ресурс]. – URL: https://github.com/typst/svg2pdf (дата обращения 09.12.2024).
. GhostScript [Электронный ресурс]. – URL: https://www.ghostscript.com/ (дата обращения 09.12.2024).
. MDN [Электронный ресурс]. – URL: https://developer.mozilla.org/en-US/ (дата обращения 09.12.2024).
. Void Linux [Электронный ресурс]. – URL: https://voidlinux.org/ (дата обращения 09.12.2024).
. Ngrok [Электронный ресурс]. – URL: https://ngrok.com/docs (дата обращения 09.12.2024).
. GitHub [Электронный ресурс]. – URL: https://github.com/ (дата обращения 09.12.2024).
`
    // }}}
}
